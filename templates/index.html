<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Compagnon Mythic GME</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; padding-top: 20px; }
        .container { max-width: 1100px; }
        .delete-btn { color: red; text-decoration: none; }
        .delete-btn:hover { text-decoration: underline; }
        .highlight { background-color: #d1e7dd; padding: 10px; border-radius: 5px; }
        .collapsible-content { display: none; }
        .formatted-result { font-size: 0.9em; max-height: 150px; overflow-y: auto; background-color: #e9ecef; padding: 10px; border-radius: 5px; }
        .status-text { font-size: 0.9em; color: #6c757d; }
    </style>
</head>
<body>
<div class="container">
    <h1 class="text-center mb-2">Compagnon Mythic GME</h1>
    <!-- Bandeau rappelant le facteur de chaos et la sc√®ne actuelle -->
    <div class="alert alert-secondary text-center">
        <strong>Facteur Chaos actuel :</strong> <span class="chaosValue">{{ chaos_factor }}</span> &nbsp; | &nbsp;
        <strong>Sc√®ne actuelle :</strong> {% if current_scene %} {{ current_scene.title }} [{{ current_scene.status }}] {% else %} Aucune sc√®ne {% endif %}
    </div>
    <!-- Onglets Bootstrap -->
    <ul class="nav nav-tabs" id="mainTab" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" id="fate-tab" data-bs-toggle="tab" data-bs-target="#fate" type="button" role="tab">
                Questions du Destin & Facteur Chaos üé≤
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="objectives-tab" data-bs-toggle="tab" data-bs-target="#objectives" type="button" role="tab">
                Objectifs üéØ
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="players-tab" data-bs-toggle="tab" data-bs-target="#players" type="button" role="tab">
                Personnages üßô‚Äç‚ôÇÔ∏è
            </button>
        </li>        
        <li class="nav-item">
            <button class="nav-link" id="npcs-tab" data-bs-toggle="tab" data-bs-target="#npcs" type="button" role="tab">
                PNJs üë•
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="scenes-tab" data-bs-toggle="tab" data-bs-target="#scenes" type="button" role="tab">
                Sc√®nes & Chaos Roll üé≠
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="tables-tab" data-bs-toggle="tab" data-bs-target="#tables" type="button" role="tab">
                Tables Al√©atoires üé≤
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="inventories-tab" data-bs-toggle="tab" data-bs-target="#inventories" type="button" role="tab">
                Inventaires üì¶
            </button>
        </li>        
        <li class="nav-item">
            <button class="nav-link" id="d100-tab" data-bs-toggle="tab" data-bs-target="#d100" type="button" role="tab">
                Lanceur de d100 üé≤
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="journal-tab" data-bs-toggle="tab" data-bs-target="#journal" type="button" role="tab">
                Journal üìì
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="options-tab" data-bs-toggle="tab" data-bs-target="#options" type="button" role="tab">
                Options ‚öôÔ∏è
            </button>
        </li>
    </ul>
    <div class="tab-content mt-3" id="mainTabContent">
        <!-- Onglet Questions du Destin & Facteur Chaos -->
        <div class="tab-pane fade show active" id="fate" role="tabpanel" aria-labelledby="fate-tab">
            <div class="card mb-3">
                <div class="card-body">
                    <h4>Facteur de Chaos : <span class="chaosValue badge bg-warning text-dark">{{ chaos_factor }}</span></h4>
                    <button id="decreaseChaos" class="btn btn-danger">-1</button>
                    <button id="increaseChaos" class="btn btn-success me-2">+1</button>
                </div>
            </div>
            <!-- Formulaire Questions du Destin -->
            <div class="card mb-3">
                <div class="card-body">
                    <h2>Poser une Question √† l'Oracle</h2>
                    <form action="/ask_fate" method="post">
                        <div class="mb-3">
                            <input type="text" name="question" class="form-control" placeholder="Votre question" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">S√©lectionnez les probabilit√©s :</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="odds" id="odds1" value="Certain" checked>
                                <label class="form-check-label" for="odds1">Certain (90%)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="odds" id="odds2" value="Presque Certain">
                                <label class="form-check-label" for="odds2">Presque Certain (85%)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="odds" id="odds3" value="Tr√®s Probable">
                                <label class="form-check-label" for="odds3">Tr√®s Probable (75%)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="odds" id="odds4" value="Probable">
                                <label class="form-check-label" for="odds4">Probable (65%)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="odds" id="odds5" value="50/50">
                                <label class="form-check-label" for="odds5">50/50 (50%)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="odds" id="odds6" value="Improbable">
                                <label class="form-check-label" for="odds6">Improbable (35%)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="odds" id="odds7" value="Tr√®s Improbable">
                                <label class="form-check-label" for="odds7">Tr√®s Improbable (25%)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="odds" id="odds8" value="Presque Impossible">
                                <label class="form-check-label" for="odds8">Presque Impossible (15%)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="odds" id="odds9" value="Impossible">
                                <label class="form-check-label" for="odds9">Impossible (10%)</label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Poser la question</button>
                    </form>
                </div>
            </div>
            {% if last_fq %}
            <div class="card mb-3 highlight">
                <div class="card-body">
                    <h4>Derni√®re question pos√©e</h4>
                    <p>
                        <strong>Q :</strong> {{ last_fq.question }}<br>
                        <strong>Probabilit√©s :</strong> {{ last_fq.odds }}<br>
                        <strong>R√©sultat :</strong> {{ last_fq.answer }}
                        {% if last_fq.random_event %}
                            <span class="badge bg-danger">√âv√©nement al√©atoire d√©clench√© ! üéâ</span>
                        {% endif %}
                    </p>
                    <small>
                        Seuil de Oui : {{ last_fq.final_chance }}%,
                        Oui Exceptionnel ‚â§ {{ last_fq.exc_yes_threshold }},
                        Non Exceptionnel ‚â• {{ last_fq.exc_no_threshold }},
                        (Jet : {{ last_fq.roll }})
                    </small>
                </div>
            </div>
            {% endif %}
            <!-- Affichage des Questions du Destin pagin√©es -->
            <div class="card">
                <div class="card-body">
                    <h2>Historique des questions</h2>
                    <ul class="list-group">
                        {% for fq in fate_questions.items %}
                        <li class="list-group-item">
                            <strong>Q :</strong> {{ fq.question }} <br>
                            <strong>Probabilit√©s :</strong> {{ fq.odds }} | <strong>R√©ponse :</strong> {{ fq.answer }} <br>
                            <small>
                                Seuil de Oui : {{ fq.final_chance }}%,
                                Oui Exceptionnel ‚â§ {{ fq.exc_yes_threshold }},
                                Non Exceptionnel ‚â• {{ fq.exc_no_threshold }},
                                (Jet : {{ fq.roll }})
                            </small>
                            <a href="{{ url_for('delete_fate', question_id=fq.id) }}" class="float-end delete-btn">Supprimer</a>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <!-- Pagination -->
            <div class="mt-3 text-center">
                {% if fate_questions.pages > 1 %}
                    {% if fate_questions.has_prev %}
                        <a href="{{ url_for('index', fate_page=fate_questions.prev_num) }}#fate" class="btn btn-secondary">‚¨ÖÔ∏è Pr√©c√©dent</a>
                    {% endif %}
                    <span class="mx-3">Page {{ current_fate_page }} / {{ fate_questions.pages }}</span>
                    {% if fate_questions.has_next %}
                        <a href="{{ url_for('index', fate_page=fate_questions.next_num) }}#fate" class="btn btn-secondary">Suivant ‚û°Ô∏è</a>
                    {% endif %}
                {% endif %}
            </div>

        </div>

        <!-- Onglet Objectifs -->
        <div class="tab-pane fade" id="objectives" role="tabpanel" aria-labelledby="objectives-tab">
            <div class="card mb-3">
                <div class="card-body">
                    <h2>Ajouter un objectif</h2>
                    <form action="/add_objective" method="post">
                        <div class="input-group">
                            <input type="text" name="description" class="form-control" placeholder="Nouvel objectif" required>
                            <button type="submit" class="btn btn-primary">Ajouter</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <h2>Liste des objectifs</h2>
                    <ul class="list-group">
                        {% for obj in objectives %}
                        <li class="list-group-item">
                            {{ obj.description }}
                            <a href="{{ url_for('delete_objective', objective_id=obj.id) }}" class="float-end delete-btn">Supprimer</a>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>

        <!-- Onglet PNJs -->
        <div class="tab-pane fade" id="npcs" role="tabpanel" aria-labelledby="npcs-tab">
            <div class="card mb-3">
                <div class="card-body">
                    <h2>Ajouter un PNJ</h2>
                    <form action="/add_npc" method="post">
                        <div class="mb-3">
                            <input type="text" name="name" class="form-control" placeholder="Nom du PNJ" required>
                        </div>
                        <div class="mb-3">
                            <input type="text" name="description" class="form-control" placeholder="Description">
                        </div>
                        <button type="submit" class="btn btn-primary">Ajouter</button>
                    </form>
                </div>
            </div>
            <div class="card mb-3">
                <div class="card-body">
                    <h2>Liste des PNJs</h2>
                    <ul class="list-group">
                        {% for npc in npcs %}
                        <li class="list-group-item">
                            <strong>{{ npc.name }}</strong> : {{ npc.description }}
                            <a href="{{ url_for('delete_npc', npc_id=npc.id) }}" class="float-end delete-btn">Supprimer</a>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <h2>Tirage d'un PNJ al√©atoire</h2>
                    <button id="randomNpcBtn" class="btn btn-secondary">Tirer un PNJ</button>
                    <p id="randomNpcResult" class="mt-2"></p>
                </div>
            </div>
        </div>

        <!-- Onglet Sc√®nes & Chaos Roll -->
        <div class="tab-pane fade" id="scenes" role="tabpanel" aria-labelledby="scenes-tab">
            <div class="card mb-3">
                <div class="card-body">
                    <h2>Ajouter une Sc√®ne</h2>
                    <form action="/add_scene" method="post">
                        <div class="mb-3">
                            <input type="text" name="title" class="form-control" placeholder="Titre de la sc√®ne" required>
                        </div>
                        <div class="mb-3">
                            <textarea name="description" class="form-control" placeholder="Description de la sc√®ne"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Statut initial :</label>
                            <select name="status" class="form-select">
                                <option value="normale" selected>Normale</option>
                                <option value="alt√©r√©e">Alt√©r√©e</option>
                                <option value="interrompue">Interrompue</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Ajouter la sc√®ne</button>
                    </form>
                </div>
            </div>
            <!-- Bouton Chaos Roll pour la sc√®ne suivante -->
            <div class="card mb-3">
                <div class="card-body">
                    <h2>Chaos Roll pour la sc√®ne suivante</h2>
                    <button id="sceneChaosRollBtn" class="btn btn-secondary">Lancer le Chaos Roll</button>
                    <p id="sceneChaosRollResult" class="mt-2"></p>
                    <small>
                        R√®gle : sur un d10 ‚Äì si le r√©sultat > CF : sc√®ne normale ; si ‚â§ CF et impair : sc√®ne alt√©r√©e ; si ‚â§ CF et pair : sc√®ne interrompue.
                    </small>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <h2>Liste des sc√®nes</h2>
                    <ul class="list-group">
                        {% for scene in scenes %}
                        <li class="list-group-item">
                            <strong>{{ scene.title }}</strong> [{{ scene.status }}] : {{ scene.description }}
                            <a href="{{ url_for('delete_scene', scene_id=scene.id) }}" class="float-end delete-btn">Supprimer</a>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>

        <!-- Onglet Tables Al√©atoires -->
        <div class="tab-pane fade" id="tables" role="tabpanel" aria-labelledby="tables-tab">
            <div class="card mb-3">
                <div class="card-body">
                    <h2 class="text-center">Tables Al√©atoires</h2>

                    <!-- Tabs pour s√©parer les cat√©gories -->
                    <ul class="nav nav-pills mb-3 justify-content-center" id="tablesTab" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" id="mythic-tables-tab" data-bs-toggle="tab" data-bs-target="#mythic-tables" type="button" role="tab">
                                Tables par d√©faut
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="custom-tables-tab" data-bs-toggle="tab" data-bs-target="#custom-tables" type="button" role="tab">
                                Tables Personnelles
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <!-- Tables du Mythic GME -->
                        <div class="tab-pane fade show active" id="mythic-tables" role="tabpanel">
                            <h4 class="text-center">Tables par d√©faut</h4>
                            <h4 class="text-center">G√©n√©raux</h4>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-primary" onclick="rollTable('scene_adjustment')">Ajustement de Sc√®ne</button>
                                        <p id="scene_adjustmentResult"></p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-primary" onclick="rollTable('random_event_focus')">Focus d'√âv√©nement Al√©atoire</button>
                                    
                                        <p id="random_event_focusResult"></p>
                                    </div>
                                </div>
                            </div>
                            <div class="container">
                                <!-- Titre de la section -->
                                <h4 class="text-center">Tables de sens divers</h4>

                                <!-- Premi√®re ligne -->
                                <div class="row">
                                  <div class="col-md-4">
                                    <button class="btn btn-primary w-100 mb-2" onclick="rollTable('ACTIONS')">Action</button>
                                    <p id="ACTIONSResult"></p>
                                  </div>
                                  <div class="col-md-4">
                                    <button class="btn btn-primary w-100 mb-2" onclick="rollTable('DESCRIPTEURS')">Descripteur</button>
                                    <p id="DESCRIPTEURSResult"></p>
                                  </div>
                                  <div class="col-md-4">
                                    <button class="btn btn-primary w-100 mb-2" onclick="rollTable('ELEMENT_PERSONNAGE')">Personnage</button>
                                    <p id="ELEMENT_PERSONNAGEResult"></p>
                                  </div>
                                </div>
                                
                                <!-- Deuxi√®me ligne -->
                                <div class="row">
                                  <div class="col-md-4">
                                    <button class="btn btn-primary w-100 mb-2" onclick="rollTable('ELEMENT_OBJET')">Objet</button>
                                    <p id="ELEMENT_OBJETResult"></p>
                                  </div>
                                  <div class="col-md-4">
                                    <button class="btn btn-primary w-100 mb-2" onclick="rollTable('ACTIONS_COMBAT')">Action de combat</button>
                                    <p id="ACTIONS_COMBATResult"></p>
                                  </div>
                                  <div class="col-md-4">
                                    <button class="btn btn-primary w-100 mb-2" onclick="rollTable('APPARENCE')">Apparence</button>
                                    <p id="APPARENCEResult"></p>
                                  </div>
                                </div>
                                
                                <!-- Troisi√®me ligne -->
                                <div class="row">
                                  <div class="col-md-4">
                                    <button class="btn btn-primary w-100 mb-2" onclick="rollTable('IDENTITE_PERSONNAGE')">Identit√© personnage</button>
                                    <p id="IDENTITE_PERSONNAGEResult"></p>
                                  </div>
                                  <div class="col-md-4">
                                    <button class="btn btn-primary w-100 mb-2" onclick="rollTable('MOTIVATIONS')">Motivations</button>
                                    <p id="MOTIVATIONSResult"></p>
                                  </div>
                                  <div class="col-md-4">
                                    <button class="btn btn-primary w-100 mb-2" onclick="rollTable('PERSONNALITE')">Personnalit√©</button>
                                    <p id="PERSONNALITEResult"></p>
                                  </div>
                                </div>
                                
                                <!-- Quatri√®me ligne -->
                                <div class="row">
                                  <div class="col-md-4">
                                    <button class="btn btn-primary w-100 mb-2" onclick="rollTable('CAPACITE_PERSONNAGE')">Capacit√© de personnage</button>
                                    <p id="CAPACITE_PERSONNAGEResult"></p>
                                  </div>
                                  <div class="col-md-4">
                                    <button class="btn btn-primary w-100 mb-2" onclick="rollTable('TRAITS_PERSONNAGE')">Trait de personnage</button>
                                    <p id="TRAITS_PERSONNAGEResult"></p>
                                  </div>
                                  <div class="col-md-4">
                                    <button class="btn btn-primary w-100 mb-2" onclick="rollTable('DEFAUTS_PERSONNAGE')">D√©faut de personnage</button>
                                    <p id="DEFAUTS_PERSONNAGEResult"></p>
                                  </div>
                                </div>
                                
                                <!-- Cinqui√®me ligne -->
                                <div class="row">
                                  <div class="col-md-4">
                                    <button class="btn btn-primary w-100 mb-2" onclick="rollTable('DESCRIPTEUR_CITE')">Cit√©</button>
                                    <p id="DESCRIPTEUR_CITEResult"></p>
                                  </div>
                                  <div class="col-md-4">
                                    <button class="btn btn-primary w-100 mb-2" onclick="rollTable('DESCRIPTEUR_CIVILISATION')">Civilisation</button>
                                    <p id="DESCRIPTEUR_CIVILISATIONResult"></p>
                                  </div>
                                  <div class="col-md-4">
                                    <button class="btn btn-primary w-100 mb-2" onclick="rollTable('CAPACITE_CREATURE')">Capacit√© de cr√©ature</button>
                                    <p id="CAPACITE_CREATUREResult"></p>
                                  </div>
                                </div>
                                
                                <!-- Sixi√®me ligne -->
                                <div class="row">
                                  <div class="col-md-4">
                                    <button class="btn btn-primary w-100 mb-2" onclick="rollTable('DESCRIPTEUR_CREATURE')">Cr√©ature</button>
                                    <p id="DESCRIPTEUR_CREATUREResult"></p>
                                  </div>
                                  <div class="col-md-4">
                                    <button class="btn btn-primary w-100 mb-2" onclick="rollTable('MALEDICTIONS')">Mal√©dictions</button>
                                    <p id="MALEDICTIONSResult"></p>
                                  </div>
                                  <div class="col-md-4">
                                    <button class="btn btn-primary w-100 mb-2" onclick="rollTable('DESCRIPTEUR_DOMICILE')">Domicile</button>
                                    <p id="DESCRIPTEUR_DOMICILEResult"></p>
                                  </div>
                                </div>
                                
                                <!-- Septi√®me ligne -->
                                <div class="row">
                                  <div class="col-md-4">
                                    <button class="btn btn-primary w-100 mb-2" onclick="rollTable('DESCRIPTEUR_DONJON')">Donjon</button>
                                    <p id="DESCRIPTEUR_DONJONResult"></p>
                                  </div>
                                  <div class="col-md-4">
                                    <button class="btn btn-primary w-100 mb-2" onclick="rollTable('PIEGE_DONJON')">Pi√®ge</button>
                                    <p id="PIEGE_DONJONResult"></p>
                                  </div>
                                  <div class="col-md-4">
                                    <button class="btn btn-primary w-100 mb-2" onclick="rollTable('DESCRIPTEUR_FORET')">For√™t</button>
                                    <p id="DESCRIPTEUR_FORETResult"></p>
                                  </div>
                                </div>
                                
                                <!-- Huiti√®me ligne -->
                                <div class="row">
                                  <div class="col-md-4">
                                    <button class="btn btn-primary w-100 mb-2" onclick="rollTable('DIEUX')">Dieu</button>
                                    <p id="DIEUXResult"></p>
                                  </div>
                                  <div class="col-md-4">
                                    <button class="btn btn-primary w-100 mb-2" onclick="rollTable('LEGENDES')">L√©gende</button>
                                    <p id="LEGENDESResult"></p>
                                  </div>
                                  <div class="col-md-4">
                                    <button class="btn btn-primary w-100 mb-2" onclick="rollTable('LIEUX')">Endroit</button>
                                    <p id="LIEUXResult"></p>
                                  </div>
                                </div>
                                
                                <!-- Neuvi√®me ligne -->
                                <div class="row">
                                  <div class="col-md-4">
                                    <button class="btn btn-primary w-100 mb-2" onclick="rollTable('DESCRIPTEURS_OBJETS_MAGIQUES')">Objet magique</button>
                                    <p id="DESCRIPTEURS_OBJETS_MAGIQUESResult"></p>
                                  </div>
                                  <div class="col-md-4">
                                    <button class="btn btn-primary w-100 mb-2" onclick="rollTable('MUTATION')">Mutation</button>
                                    <p id="MUTATIONResult"></p>
                                  </div>
                                  <div class="col-md-4">
                                    <button class="btn btn-primary w-100 mb-2" onclick="rollTable('DESCRIPTEUR_NOMS')">Nom</button>
                                    <p id="DESCRIPTEUR_NOMSResult"></p>
                                  </div>
                                </div>
                                
                                <!-- Dixi√®me ligne -->
                                <div class="row">
                                  <div class="col-md-4">
                                    <button class="btn btn-primary w-100 mb-2" onclick="rollTable('SYLLABE_NOMS')">Syllabe de nom</button>
                                    <p id="SYLLABE_NOMSResult"></p>
                                  </div>
                                  <div class="col-md-4">
                                    <button class="btn btn-primary w-100 mb-2" onclick="rollTable('POUVOIR')">Pouvoir</button>
                                    <p id="POUVOIRResult"></p>
                                  </div>
                                  <div class="col-md-4">
                                    <button class="btn btn-primary w-100 mb-2" onclick="rollTable('R√äVE')">R√™ve</button>
                                    <p id="R√äVEResult"></p>
                                  </div>
                                </div>
                                
                                <!-- Onzi√®me ligne -->
                                <div class="row">
                                  <div class="col-md-4">
                                    <button class="btn btn-primary w-100 mb-2" onclick="rollTable('REBONDISSEMENT')">Rebondissement</button>
                                    <p id="REBONDISSEMENTResult"></p>
                                  </div>
                                  <div class="col-md-4">
                                    <button class="btn btn-primary w-100 mb-2" onclick="rollTable('R√âSULTAT_DE_FOUILLE')">R√©sultat de fouille</button>
                                    <p id="R√âSULTAT_DE_FOUILLEResult"></p>
                                  </div>
                                  <div class="col-md-4">
                                    <button class="btn btn-primary w-100 mb-2" onclick="rollTable('ODEUR')">Odeur</button>
                                    <p id="ODEURResult"></p>
                                  </div>
                                </div>
                                
                                <!-- Douzi√®me ligne -->
                                <div class="row">
                                  <div class="col-md-4">
                                    <button class="btn btn-primary w-100 mb-2" onclick="rollTable('SONS')">Son</button>
                                    <p id="SONSResult"></p>
                                  </div>
                                  <div class="col-md-4">
                                    <button class="btn btn-primary w-100 mb-2" onclick="rollTable('EFFET_DE_SORT')">Effet de sort</button>
                                    <p id="EFFET_DE_SORTResult"></p>
                                  </div>
                                  <div class="col-md-4">
                                    <button class="btn btn-primary w-100 mb-2" onclick="rollTable('DESCRIPTEUR_VAISSEAU_SPATIAL')">Vaisseau Spatial</button>
                                    <p id="DESCRIPTEUR_VAISSEAU_SPATIALResult"></p>
                                  </div>
                                </div>
                                
                                <!-- Treizi√®me ligne -->
                                <div class="row">
                                  <div class="col-md-4">
                                    <button class="btn btn-primary w-100 mb-2" onclick="rollTable('DESCRIPTEUR_TERRAIN')">Terrain</button>
                                    <p id="DESCRIPTEUR_TERRAINResult"></p>
                                  </div>
                                  <div class="col-md-4">
                                    <button class="btn btn-primary w-100 mb-2" onclick="rollTable('DESCRIPTEUR_MORT_VIVANT')">Mort Vivant</button>
                                    <p id="DESCRIPTEUR_MORT_VIVANTResult"></p>
                                  </div>
                                  <div class="col-md-4">
                                    <!-- Pour √©quilibrer, on peut laisser vide ou ajouter un espace -->
                                  </div>
                                </div>
                                
                              </div>
                              
                        </div>

                        <!-- Tables Personnelles -->
                        <div class="tab-pane fade" id="custom-tables" role="tabpanel">
                            <h4 class="text-center">Tables Personnelles</h4>
                            <!-- Liste des tables personnalis√©es sauvegard√©es -->
                            <div id="customTablesContainer" class="mt-3">
                                {% if custom_tables|length == 0 %}
                                <p class="text-muted text-center">Aucune table ajout√©e pour le moment.</p>
                                {% else %}
                                {% for table in custom_tables %}
                                <div class="card mb-2">
                                    <div class="card-body">
                                        <h5>{{ table.name }}</h5>
                                        <pre class="collapsible-content" id="tableContent-{{ table.id }}">{{ table.values }}</pre>
                                        <button class="btn btn-outline-secondary btn-sm" onclick="toggleTableContent('{{ table.id }}')">
                                            <span class="d-inline-block text-truncate" style="max-width: 100px;">Voir le contenu</span>
                                        </button>
                                        <div class="d-flex justify-content-end">
                                            <button class="btn btn-secondary btn-sm me-2" onclick="rollCustomTable('{{ table.id }}')">Lancer</button>
                                            <button class="btn btn-warning btn-sm me-2" onclick="openEditModal('{{ table.id }}')">√âditer</button>
                                            <a href="{{ url_for('delete_custom_table', table_id=table.id) }}" class="btn btn-danger btn-sm">Supprimer</a>
                                        </div>
                                        <!-- Ajout d‚Äôun conteneur pour afficher le r√©sultat -->
                                        <p id="customTableResult-{{ table.id }}" class="mt-2 text-center fw-bold"></p>
                                    </div>
                                </div>
                                {% endfor %}
                                {% endif %}
                            </div>
                            
                            <!-- Formulaire d'ajout -->
                            <div class="mt-4">
                                <h5>Ajouter une Table Personnelle</h5>
                                <form action="/add_custom_table" method="post">
                                    <div class="mb-2">
                                        <input type="text" name="customTableName" id="customTableName" class="form-control" placeholder="Nom de la table" required>
                                    </div>
                                    <div class="mb-2">
                                        <textarea name="customTableValues" id="customTableValues" class="form-control" rows="3" placeholder="Liste des valeurs, une par ligne" required></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-success">Ajouter</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fen√™tre d'√©dition de table personnelle -->
        <div class="modal fade" id="editCustomTableModal" tabindex="-1" aria-labelledby="editCustomTableModalLabel" aria-hidden="true">
            <div class="modal-dialog">
              <form action="" method="post" id="editCustomTableForm">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="editCustomTableModalLabel">√âditer la Table Personnelle üõ†Ô∏è</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                  </div>
                  <div class="modal-body">
                      <div class="mb-2">
                          <label for="customTableNameEdit" class="form-label">Nom de la table</label>
                          <input type="text" name="customTableNameEdit" id="customTableNameEdit" class="form-control" required>
                      </div>
                      <div class="mb-2">
                          <label for="customTableValuesEdit" class="form-label">Valeurs de la table (une par ligne)</label>
                          <textarea name="customTableValuesEdit" id="customTableValuesEdit" class="form-control" rows="5" required></textarea>
                      </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                  </div>
                </div>
              </form>
            </div>
        </div>

        <!-- Onglet Journal -->
        <div class="tab-pane fade" id="journal" role="tabpanel" aria-labelledby="journal-tab">
            <div class="card mb-3">
                <div class="card-body">
                    <h2 class="text-center">Journal</h2>
                    <!-- Formulaire pour ajouter une entr√©e -->
                    <form action="/add_journal_entry" method="post">
                        <div class="mb-2">
                            <textarea id="journalText" name="content" class="form-control" rows="3" placeholder="√âcris une nouvelle entr√©e..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Ajouter</button>
                    </form>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <button id="startRecording" class="btn btn-secondary">üé§ Dict√©e</button>
                        <button id="formatJournal" class="btn btn-primary">üìù R√©sumer avec OpenAI</button>
                        <button id="useSummary" class="btn btn-success">Utiliser le R√©sum√©</button>
                    </div>
                    <p id="recordingStatus" class="status-text mt-2"></p>
                    <div id="formattedResult" class="formatted-result mt-3"></div>
                </div>
            </div>

            <!-- Affichage des entr√©es -->
            <div class="card">
                <div class="card-body">
                    <h4>Entr√©es r√©centes</h4>
                    {% if journal_entries.items %}
                        <ul class="list-group">
                            {% for entry in journal_entries.items %}
                            <li class="list-group-item">
                                <small class="text-muted">{{ entry.date.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                                <p class="entry-content" id="entry-content-{{ entry.id }}" data-full-content="{{ entry.content }}" style="white-space: pre-line;">
                                    {{ entry.content.split('\n')[0] }}
                                </p>
                                {% if entry.content.split('\n')|length > 1 %}
                                <a href="javascript:void(0)" id="toggle-link-{{ entry.id }}" onclick="toggleEntryContent({{ entry.id }})">Voir plus</a>
                                {% endif %}
                                <a href="{{ url_for('delete_journal_entry', entry_id=entry.id) }}" class="text-danger float-end">Supprimer</a>
                            </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted text-center">Aucune entr√©e pour le moment.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Pagination -->
            <div class="mt-3 text-center">
                {% if journal_entries.pages > 1 %}
                    {% if journal_entries.has_prev %}
                        <a href="{{ url_for('journal', page=journal_entries.prev_num) }}" class="btn btn-secondary">‚¨ÖÔ∏è Pr√©c√©dent</a>
                    {% endif %}
                    <span class="mx-3">Page {{ current_page }} / {{ journal_entries.pages }}</span>
                    {% if journal_entries.has_next %}
                        <a href="{{ url_for('journal', page=journal_entries.next_num) }}" class="btn btn-secondary">Suivant ‚û°Ô∏è</a>
                    {% endif %}
                {% endif %}
            </div>

            <!-- Bouton d'export -->
            <div class="mt-4 text-center">
                <a href="{{ url_for('export_journal') }}" class="btn btn-success">üì• Exporter en Markdown</a>
            </div>
        </div>
        <!-- Onglet Inventaires -->
        <div class="tab-pane fade" id="inventories" role="tabpanel" aria-labelledby="inventories-tab">
            <div class="card mb-3">
                <div class="card-body">
                    <h2 class="text-center">Gestion des Inventaires</h2>

                    <!-- Formulaire pour ajouter un nouvel inventaire -->
                    <form action="/add_inventory" method="post" class="mb-3">
                        <div class="input-group">
                            <input type="text" name="title" class="form-control" placeholder="Nom de l'inventaire" required>
                            <button type="submit" class="btn btn-primary">Ajouter</button>
                        </div>
                    </form>

                    <!-- Liste des inventaires -->
                    <ul class="list-group">
                        {% for inventory in inventories %}
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <strong>{{ inventory.title }}</strong>
                                <div>
                                    <button class="btn btn-secondary btn-sm me-2" onclick="toggleItems({{ inventory.id }})">üìù Voir</button>
                                    <a href="{{ url_for('delete_inventory', inventory_id=inventory.id) }}" class="btn btn-danger btn-sm">‚ùå Supprimer</a>
                                </div>
                            </div>

                            <!-- Contenu des √©l√©ments de l'inventaire -->
                            <div id="items-{{ inventory.id }}" class="mt-2 d-none">
                                <ul class="list-group">
                                    {% for item in inventory.items %}
                                    <li class="list-group-item">
                                        <strong>{{ item.name }}</strong>: {{ item.description }} 
                                        <span id="quantity-{{ item.id }}" class="badge bg-secondary">Quantit√©:  {{ item.quantity }}</span>
                                        <div class="d-flex justify-content-end">
                                            <button class="btn btn-danger btn-sm me-1" onclick="updateItemQuantity({{ item.id }}, 'decrease')">-</button>
                                            <button class="btn btn-success btn-sm me-2" onclick="updateItemQuantity({{ item.id }}, 'increase')">+</button>
                                            <a href="{{ url_for('delete_inventory_item', item_id=item.id) }}" class="btn btn-danger btn-sm">‚ùå</a>
                                        </div>
                                    </li>
                                    {% endfor %}
                                </ul>

                                <!-- Formulaire pour ajouter un √©l√©ment -->
                                <form action="/add_inventory_item/{{ inventory.id }}" method="post" class="mt-2">
                                    <div class="input-group">
                                        <input type="text" name="name" class="form-control" placeholder="Nom de l'objet" required>
                                        <input type="text" name="description" class="form-control" placeholder="Description">
                                        <input type="number" name="quantity" class="form-control" placeholder="Quantit√©" min="1" value="1" required>
                                        <button type="submit" class="btn btn-success">‚ûï Ajouter</button>
                                    </div>
                                </form>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>

        <!-- Onglet Personnages -->
        <div class="tab-pane fade" id="players" role="tabpanel" aria-labelledby="players-tab">
            <div class="card mb-3">
                <div class="card-body">
                    <h2 class="text-center">Gestion des Personnages</h2>

                    <!-- Formulaire pour ajouter un PJ -->
                    <form action="/add_player" method="post" class="mb-3">
                        <div class="input-group">
                            <input type="text" name="name" class="form-control" placeholder="Nom du personnage" required>
                            <input type="text" name="description" class="form-control" placeholder="Description">
                            <button type="submit" class="btn btn-primary">Ajouter</button>
                        </div>
                    </form>

                    <!-- Liste des personnages -->
                    <ul class="list-group">
                        {% for player in players %}
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <strong>{{ player.name }}</strong>
                                <div>
                                    <button class="btn btn-secondary btn-sm me-2" onclick="toggleAttributes({{ player.id }})">üìã Attributs</button>
                                    <button class="btn btn-secondary btn-sm me-2" onclick="toggleDescEdit({{ player.id }})">‚úèÔ∏è Modifier Description</button>
                                    <a href="{{ url_for('delete_player', player_id=player.id) }}" class="btn btn-danger btn-sm">‚ùå Supprimer</a>
                                </div>
                            </div>

                            <!-- Zone de description en mode lecture -->
                            <div id="desc-view-{{ player.id }}" class="mt-2">
                                {% if player.description %}
                                {% set lines = player.description.split('\n') %}
                                <span id="desc-short-{{ player.id }}" style="white-space: pre-line;">{{ lines[0] }}</span>
                                {% if lines|length > 1 %}
                                    <span id="desc-full-{{ player.id }}" class="d-none" style="white-space: pre-line;"><br>{{ lines[1:] | join('\n') }}</span>
                                    <a href="javascript:void(0)" id="toggleDescLink-{{ player.id }}" onclick="toggleFullDesc({{ player.id }})"> ‚Ä¶Voir plus</a>
                                {% endif %}
                                {% else %}
                                Aucune description.
                                {% endif %}
                            </div>
        
                            <!-- Zone de description en mode √©dition (cach√©e par d√©faut) -->
                            <form id="desc-edit-{{ player.id }}" class="d-none" action="/edit_player_description/{{ player.id }}" method="post">
                                <textarea name="description" class="form-control" rows="4" id="desc-textarea-{{ player.id }}">{{ player.description }}</textarea>
                                <button type="submit" class="btn btn-success btn-sm mt-2">üíæ Enregistrer</button>
                                <button type="button" class="btn btn-secondary btn-sm mt-2" onclick="toggleDescEdit({{ player.id }})">‚ùå Annuler</button>
                            </form>

                            <!-- Zone d'attributs (affichage et gestion) -->
                            <div id="attributes-{{ player.id }}" class="mt-2 d-none">
                                <ul class="list-group">
                                    {% for attr in player.attributes %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>{{ attr.attribute_name }}</strong> :
                                            <span id="attr-value-{{ attr.id }}">{{ attr.attribute_value }}</span>
                                        </div>
                                        <div>
                                            {% if attr.is_numeric %}
                                                <button class="btn btn-danger btn-sm me-1" onclick="updateAttribute({{ attr.id }}, 'decrease')">-</button>
                                                <button class="btn btn-success btn-sm me-2" onclick="updateAttribute({{ attr.id }}, 'increase')">+</button>
                                            {% endif %}
                                            <a href="{{ url_for('delete_player_attribute', attribute_id=attr.id) }}" class="btn btn-danger btn-sm">‚ùå</a>
                                        </div>
                                    </li>
                                    {% endfor %}
                                </ul>
                                <!-- Formulaire pour ajouter un attribut -->
                                <form action="/add_player_attribute/{{ player.id }}" method="post" class="mt-2" onsubmit="return validateAttributeForm({{ player.id }})">
                                    <div class="input-group">
                                        <input type="text" name="attribute_name" class="form-control" placeholder="Nom de l'attribut" required>
                                        <input type="text" name="attribute_value" id="attribute_value_{{ player.id }}" class="form-control" placeholder="Valeur" required>
                                        <span class="input-group-text">
                                            <input type="checkbox" name="is_numeric" id="is_numeric_{{ player.id }}" onchange="toggleNumericValidation({{ player.id }})">
                                            <label for="is_numeric_{{ player.id }}" class="mb-0 ms-1">Num√©rique</label>
                                        </span>
                                        <button type="submit" class="btn btn-success">‚ûï Ajouter</button>
                                    </div>
                                    <p id="error-msg-{{ player.id }}" class="text-danger mt-1 d-none">‚ö†Ô∏è La valeur doit √™tre un nombre si "Num√©rique" est coch√©.</p>
                                </form>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="options" role="tabpanel" aria-labelledby="options-tab">
            <div class="card mb-3">
                <div class="card-body">
                    <h2 class="text-center">Options</h2>
                    <form action="/update_openai_key" method="post">
                        <label for="api_key" class="form-label">Cl√© API OpenAI</label>
                        <input type="password" id="api_key" name="api_key" class="form-control" value="{{ openai_key }}" required>
                        <button type="submit" class="btn btn-primary mt-2">Enregistrer</button>
                    </form>
                </div>
            </div>
        </div>

<!-- Fin de la section Onglets -->
          
<script>
    // Charger toutes les tables dans une variable JavaScript pour √©viter les erreurs de saut de ligne
    let customTables = {{ custom_tables_json|safe }};

    // Fonction pour tirer dans une table personnelle sauvegard√©e
    function rollCustomTable(tableId) {
        // On envoie une requ√™te vers un endpoint qui n'est pas encore d√©fini c√¥t√© serveur
        // Pour simplifier, nous r√©cup√©rons les valeurs depuis un objet JavaScript construit √† partir des tables sauvegard√©es.
        // Ici, nous allons utiliser une requ√™te AJAX pour obtenir les valeurs de la table.
        fetch("/get_custom_table?table_id=" + parseInt(tableId, 10))
        .then(response => response.json())
        .then(data => {
        if (data.error) {
            document.getElementById("customTableResult-" + tableId).innerText = "Erreur : " + data.error;
        } else {
            const values = data.values.split("\n").filter(v => v.trim() !== "");
            if (values.length > 0) {
                const roll = Math.floor(Math.random() * values.length);
                document.getElementById("customTableResult-" + tableId).innerText = "üé≤ R√©sultat : " + values[roll];
            } else {
                document.getElementById("customTableResult-" + tableId).innerText = "‚ö†Ô∏è La table est vide.";
            }
        }
    });
}

    // Pour √©diter une table personnalis√©e, on ouvre le modal et on remplit les champs
    function openEditModal(tableId) {
        console.log(tableId);
        console.log(customTables);
    const table = customTables.find(t => t.id === parseInt(tableId, 10));
    console.log(table);
    console.log('edit');
    if (table) {
        console.log('edittable');
        document.getElementById("editCustomTableForm").action = "/edit_custom_table/" + table.id;
        document.getElementById("customTableNameEdit").value = table.name;
        document.getElementById("customTableValuesEdit").value = table.values.replace(/\\n/g, "\n"); // R√©tablir les sauts de ligne
        const modal = new bootstrap.Modal(document.getElementById("editCustomTableModal"));
        modal.show();
    }
}

    // Fonction pour afficher/masquer le contenu d'une table
    function toggleTableContent(tableId) {
        const content = document.getElementById("tableContent-" + tableId);
        if (content.style.display === "none" || content.style.display === "") {
            content.style.display = "block";
        } else {
            content.style.display = "none";
        }
    }

    // Fonction pour mettre √† jour la quantit√© d'un objet
    function updateItemQuantity(itemId, operation) {
        fetch(`/update_item_quantity/${itemId}/${operation}`, { method: "POST" })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Mettre √† jour la quantit√© de l'√©l√©ment sp√©cifique
                document.getElementById(`quantity-${itemId}`).innerText = data.new_quantity;
            } else {
                console.error("Erreur lors de la mise √† jour de la quantit√©.");
            }
        })
        .catch(error => console.error("Erreur r√©seau :", error));
    }
</script>
        <!-- Onglet Lanceur de d√©s -->
        <div class="tab-pane fade" id="d100" role="tabpanel" aria-labelledby="d100-tab">
            <div class="card mb-3">
                <div class="card-body text-center">
                    <h2>Lanceur de d√©s</h2>
                    <div class="d-grid gap-2 d-md-inline-block">
                        <button class="btn btn-primary" onclick="rollDice(2)">D2</button>
                        <button class="btn btn-primary" onclick="rollDice(4)">D4</button>
                        <button class="btn btn-primary" onclick="rollDice(6)">D6</button>
                        <button class="btn btn-primary" onclick="rollDice(8)">D8</button>
                        <button class="btn btn-primary" onclick="rollDice(12)">D12</button>
                        <button class="btn btn-primary" onclick="rollDice(20)">D20</button>
                        <button class="btn btn-primary" onclick="rollDice(100)">D100</button>
                    </div>
                    <p id="diceResult" class="mt-3" style="font-size: 2em;"></p>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <h3>Historique des 10 derniers lancers</h3>
                    <ul id="rollHistory" class="list-group">
                        <!-- Les lancers seront affich√©s ici -->
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS et scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function(){
        const activeTab = localStorage.getItem('activeTab');
        if(activeTab){
            const tabTrigger = document.querySelector(activeTab);
            if(tabTrigger){
                new bootstrap.Tab(tabTrigger).show();
            }
        }
    });

    document.addEventListener("DOMContentLoaded", function() {
        const entryContents = document.querySelectorAll(".entry-content");

        entryContents.forEach(entry => {
            const fullContent = entry.dataset.fullContent;
            const firstLine = fullContent.split('\n')[0];
            entry.textContent = firstLine; // Ensure initial state is the first line
            if (fullContent.split('\n').length > 1) {
                entry.textContent += '...'; // Add ellipsis if there is more content
            }
            entry.dataset.isSummary = "true"; // Track the initial mode
        });
    });

    let triggerTabs = document.querySelectorAll('#mainTab button');
    triggerTabs.forEach(tab => {
        tab.addEventListener('shown.bs.tab', function (event) {
            localStorage.setItem('activeTab', '#' + event.target.id);
        });
    });

    // Tirage d'un PNJ al√©atoire
    document.getElementById("randomNpcBtn")?.addEventListener("click", function(){
        fetch("/random_npc")
        .then(response => response.json())
        .then(data => {
            if(data.error) {
                document.getElementById("randomNpcResult").innerText = data.error;
            } else {
                document.getElementById("randomNpcResult").innerText = data.name + " : " + data.description;
            }
        });
    });

    // Lanceur de d100
    document.getElementById("rollD100Btn")?.addEventListener("click", function(){
        fetch("/roll_d100")
        .then(response => response.json())
        .then(data => {
            document.getElementById("d100Result").innerText = "R√©sultat du d100 : " + data.roll;
        });
    });

    // Chaos Roll pour la sc√®ne suivante
    document.getElementById("sceneChaosRollBtn")?.addEventListener("click", function(){
        fetch("/scene_chaos_roll")
        .then(response => response.json())
        .then(data => {
            document.getElementById("sceneChaosRollResult").innerText = "Jet : " + data.roll + " ‚Üí Sc√®ne " + data.status;
            // Update the dropdown based on the chaos roll result
            const statusSelect = document.querySelector('select[name="status"]');
            if (statusSelect) {
                statusSelect.value = data.status;
            }
        });
    });

    // Tirage dans les tables al√©atoires
    function rollTable(tableName) {
        console.log(tableName);
    fetch("/roll_table?table=" + tableName)
    .then(response => response.json())
    .then(data => {
        // Construire l'ID de l'√©l√©ment de r√©sultat √† partir de tableName
        let elementId = tableName + "Result";
        let resultElement = document.getElementById(elementId);
        if (resultElement) {
            resultElement.innerText = "Jet : " + data.roll + " ‚Üí " + data.result;
        } else {
            console.error("Aucun √©l√©ment avec l'ID :", elementId);
        }
    })
    .catch(error => console.error("Erreur lors du tirage de la table :", error));
}
    
    function toggleItems(inventoryId) {
        let itemsDiv = document.getElementById("items-" + inventoryId);
        if (itemsDiv.classList.contains("d-none")) {
            itemsDiv.classList.remove("d-none");
        } else {
            itemsDiv.classList.add("d-none");
        }
    }

    function toggleAttributes(playerId) {
        let attrDiv = document.getElementById("attributes-" + playerId);
        if (attrDiv.classList.contains("d-none")) {
            attrDiv.classList.remove("d-none");
        } else {
            attrDiv.classList.add("d-none");
        }
    }

    function toggleDescEdit(playerId) {
        let view = document.getElementById("desc-view-" + playerId);
        let edit = document.getElementById("desc-edit-" + playerId);
        if (edit.classList.contains("d-none")) {
            edit.classList.remove("d-none");
            view.classList.add("d-none");
        } else {
            edit.classList.add("d-none");
            view.classList.remove("d-none");
        }
    }

    function toggleFullDesc(playerId) {
      var fullSpan = document.getElementById("desc-full-" + playerId);
      var toggleLink = document.getElementById("toggleDescLink-" + playerId);
      if (fullSpan.classList.contains("d-none")) {
          fullSpan.classList.remove("d-none");
          toggleLink.innerText = " ‚Ä¶Voir moins";
      } else {
          fullSpan.classList.add("d-none");
          toggleLink.innerText = " ‚Ä¶Voir plus";
      }
    }

    function updateAttribute(attributeId, operation) {
        fetch(`/update_attribute/${attributeId}/${operation}`, { method: "POST" })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById(`attr-value-${attributeId}`).innerText = data.new_value;
            } else {
                console.error("Erreur lors de la mise √† jour de l'attribut.");
            }
        })
        .catch(error => console.error("Erreur r√©seau :", error));
    }

    function validateAttributeForm(playerId) {
        let isNumericChecked = document.getElementById(`is_numeric_${playerId}`).checked;
        let attributeValue = document.getElementById(`attribute_value_${playerId}`).value.trim();
        let errorMsg = document.getElementById(`error-msg-${playerId}`);

        if (isNumericChecked && isNaN(attributeValue)) {
            errorMsg.classList.remove("d-none");  // Afficher l'erreur
            return false;  // Bloquer l'envoi du formulaire
        }

        errorMsg.classList.add("d-none");  // Masquer l'erreur si tout est bon
        return true;  // Autoriser l'envoi du formulaire
    }

    function toggleNumericValidation(playerId) {
        let errorMsg = document.getElementById(`error-msg-${playerId}`);
        errorMsg.classList.add("d-none");  // Masquer l'erreur si on d√©coche
    }

    function toggleEntryContent(entryId) {
        const entryContent = document.getElementById(`entry-content-${entryId}`);
        const toggleLink = document.getElementById(`toggle-link-${entryId}`);
        const fullContent = entryContent.dataset.fullContent;
        const firstLine = fullContent.split('\n')[0];
        const isSummary = entryContent.dataset.isSummary === "true";

        if (isSummary) {
            entryContent.textContent = fullContent;
            toggleLink.textContent = "Voir moins";
            entryContent.dataset.isSummary = "false";
        } else {
            entryContent.textContent = firstLine;
            if (fullContent.split('\n').length > 1) {
                entryContent.textContent += '...'; // Add ellipsis if there is more content
            }
            toggleLink.textContent = "Voir plus";
            entryContent.dataset.isSummary = "true";
        }
    }

    // Fonction pour mettre √† jour le facteur de chaos via AJAX
    function updateChaos(adjustment) {
        fetch("/update_chaos", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: "adjustment=" + adjustment
        })
        .then(response => response.json())
        .then(data => {
            // Mettre √† jour tous les √©l√©ments avec la classe "chaosValue"
            document.querySelectorAll(".chaosValue").forEach(function(elem) {
                elem.innerText = data.new_chaos;
            });
        })
        .catch(error => console.error("Erreur lors de la mise √† jour du chaos :", error));
    }

    // Associer les √©v√©nements de clic aux boutons de mise √† jour
    document.getElementById("decreaseChaos").addEventListener("click", function(){
        updateChaos(-1);
    });

    document.getElementById("increaseChaos").addEventListener("click", function(){
        updateChaos(1);
    });

    // Fonction pour mettre √† jour l'historique stock√© dans le localStorage
    function saveRollHistory(historyArray) {
        localStorage.setItem("diceHistory", JSON.stringify(historyArray));
    }

    // Fonction pour r√©cup√©rer l'historique depuis le localStorage
    function loadRollHistory() {
        let history = localStorage.getItem("diceHistory");
        return history ? JSON.parse(history) : [];
    }

    // Fonction pour afficher l'historique dans la page
    function displayRollHistory() {
        let historyList = document.getElementById("rollHistory");
        historyList.innerHTML = ""; // vider la liste
        let historyArray = loadRollHistory();
        historyArray.forEach(entry => {
            let listItem = document.createElement("li");
            listItem.className = "list-group-item";
            listItem.innerText = entry;
            historyList.appendChild(listItem);
        });
    }

    // Fonction pour ajouter le r√©sultat √† l'historique
    function addRollToHistory(resultText) {
        let historyArray = loadRollHistory();
        // Ajoute le nouvel √©l√©ment en haut du tableau
        let now = new Date();
        let entry = now.toLocaleString() + " : " + resultText;
        historyArray.unshift(entry);
        // Conserver uniquement les 15 derniers lancers
        historyArray = historyArray.slice(0, 15);
        saveRollHistory(historyArray);
        displayRollHistory();
    }

    // Au chargement de la page, afficher l'historique existant
    document.addEventListener("DOMContentLoaded", displayRollHistory);

    // Fonction qui effectue un lancer de d√©
    function rollDice(faces) {
        fetch("/roll_dice/" + faces)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById("diceResult").innerText = "Erreur: " + data.error;
            } else {
                const resultText = "D" + data.faces + ": " + data.roll;
                document.getElementById("diceResult").innerHTML = resultText;
                // Une fois le lancer effectu√©, on recharge l'historique
                loadDiceHistory();
            }
        })
        .catch(error => console.error("Erreur lors du lancer de d√©s :", error));
    }

    // Fonction pour charger l'historique des lancers depuis SQL
    function loadDiceHistory() {
        fetch("/dice_history")
        .then(response => response.json())
        .then(data => {
            const historyList = document.getElementById("rollHistory");
            historyList.innerHTML = "";
            data.forEach(entry => {
                const listItem = document.createElement("li");
                listItem.className = "list-group-item";
                listItem.innerHTML = "<em>(D" + entry.faces + ")</em> ‚Üí <strong>" + entry.roll + "</strong>";
                historyList.appendChild(listItem);
            });
        })
        .catch(error => console.error("Erreur lors du chargement de l'historique :", error));
    }

    // Charger l'historique au chargement de la page
    document.addEventListener("DOMContentLoaded", loadDiceHistory);

    // Code Dict√©e
    let mediaRecorder;
    let audioChunks = [];

    document.getElementById("startRecording").addEventListener("click", async () => {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            alert("Votre navigateur ne supporte pas l'enregistrement audio.");
            return;
        }

        if (mediaRecorder && mediaRecorder.state === "recording") {
            mediaRecorder.stop();
            return;
        }

        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.ondataavailable = event => {
            audioChunks.push(event.data);
        };

        mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
            const formData = new FormData();
            formData.append("audio", audioBlob);

            console.log(audioBlob);
            document.getElementById("recordingStatus").innerText = "Analyse en cours...";
            document.getElementById("startRecording").disabled = true; // Disable button

            fetch("/transcribe_audio", {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById("recordingStatus").innerText = "Transcription termin√©e.";
                document.querySelector("textarea[name='content']").value += data.transcription;
            })
            .catch(() => {
                document.getElementById("recordingStatus").innerText = "Erreur lors de la transcription.";
            })
            .finally(() => {
                audioChunks = []; // Clear the audio chunks after processing
                document.getElementById("startRecording").disabled = false; // Re-enable button
            });
        };

        mediaRecorder.start();
        document.getElementById("recordingStatus").innerText = "Enregistrement en cours... Cliquez √† nouveau pour arr√™ter.";
    });

    document.getElementById("formatJournal").addEventListener("click", function() {
        let journalText = document.getElementById("journalText").value;

        if (journalText.trim() === "") {
            alert("Le champ du journal est vide.");
            return;
        }

        document.getElementById("recordingStatus").innerText = "G√©n√©ration du r√©sum√© en cours...";
        document.getElementById("formatJournal").disabled = true; // Disable button

        fetch("/reformat_journal", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: "journal_text=" + encodeURIComponent(journalText)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert("Erreur : " + data.error);
            } else {
                document.getElementById("formattedResult").innerText = data.formatted_text;
                document.getElementById("recordingStatus").innerText = "R√©sum√© g√©n√©r√©.";
            }
        })
        .catch(error => console.error("Erreur lors de la reformulation du journal :", error))
        .finally(() => {
            document.getElementById("formatJournal").disabled = false; // Re-enable button
        });
    });

    document.getElementById("useSummary").addEventListener("click", function() {
        const summaryText = document.getElementById("formattedResult").innerText;
        if (summaryText.trim() !== "") {
            document.getElementById("journalText").value = summaryText;
        }
    });
</script>
</body>
</html>
